<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Android,">










<meta name="description" content="使用ContentProvider实现数据共享为了在应用程序之间交换数据，Android提供了ContentProvider，ContentProvider是不同应用程序之间进行数据交换的标准API，当一个应用程序需要把自己的数据暴露给其他程序使用时，该应用程序就可通过提供ContentProvider来实现；其他应用程序就可通过ContentResolver来操作ContentProvider暴">
<meta name="keywords" content="Android">
<meta property="og:type" content="article">
<meta property="og:title" content="疯狂Android第三部分">
<meta property="og:url" content="https://frandfeng.github.io/2012/10/26/疯狂Android第三部分/index.html">
<meta property="og:site_name" content="Frand Feng">
<meta property="og:description" content="使用ContentProvider实现数据共享为了在应用程序之间交换数据，Android提供了ContentProvider，ContentProvider是不同应用程序之间进行数据交换的标准API，当一个应用程序需要把自己的数据暴露给其他程序使用时，该应用程序就可通过提供ContentProvider来实现；其他应用程序就可通过ContentResolver来操作ContentProvider暴">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-11-23T09:50:46.405Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="疯狂Android第三部分">
<meta name="twitter:description" content="使用ContentProvider实现数据共享为了在应用程序之间交换数据，Android提供了ContentProvider，ContentProvider是不同应用程序之间进行数据交换的标准API，当一个应用程序需要把自己的数据暴露给其他程序使用时，该应用程序就可通过提供ContentProvider来实现；其他应用程序就可通过ContentResolver来操作ContentProvider暴">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://frandfeng.github.io/2012/10/26/疯狂Android第三部分/">





  <title>疯狂Android第三部分 | Frand Feng</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?033e49e2955598a86e6aef7bb5784a98";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Frand Feng</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Win yourself to succeed!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://frandfeng.github.io/2012/10/26/疯狂Android第三部分/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Frand Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Frand Feng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">疯狂Android第三部分</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2012-10-26T00:00:00+08:00">
                2012-10-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="使用ContentProvider实现数据共享"><a href="#使用ContentProvider实现数据共享" class="headerlink" title="使用ContentProvider实现数据共享"></a>使用ContentProvider实现数据共享</h2><p>为了在应用程序之间交换数据，Android提供了ContentProvider，ContentProvider是不同应用程序之间进行数据交换的标准API，当一个应用程序需要把自己的数据暴露给其他程序使用时，该应用程序就可通过提供ContentProvider来实现；其他应用程序就可通过ContentResolver来操作ContentProvider暴露的数据</p>
<blockquote>
<p>ContentProvider也是Android应用的四大组件之一，与Activity、Service、BroadcastReceiver相似，都需要在AndroidManifest.xml中进行配置</p>
</blockquote>
<p>ContentProvider是不同应用程序之间进行数据交换的标准API，ContentProvider以某种Uri的形式对外提供数据，允许其他应用访问或修改数据；其他应用程序使用ContentResolver根据Uri去访问操作指定数据。</p>
<p>完整地开发一个ContentProvider的步骤如下：</p>
<ol>
<li>定义自己的ContentProvider类，该类需要集成Android提供的ContentProvider基类</li>
<li><p>向Android系统注册这个Provider，也就是在AndroidManifest.xml文件中注册这个ContentProvider，就像注册Activity一样。注册ContentProvider时需要为它绑定一个域名</p>
<pre><code>&lt;!--下面配置中name属性指定ContentProvider类
    authorities就相当于为该ContentProvider指定域名--&gt;
&lt;provider android:name=&quot;.DictProvider&quot;
    android:authorities=&quot;org.crazyit.providers.dictprovider&quot; /&gt;
</code></pre></li>
</ol>
<p>应用程序对数据的操作无非就是CRUD操作，因此DictProvider除了需要继承ContentProvider之外，还需要实现ContentProvider内的几个方法：</p>
<ol>
<li>public boolean onCreate();该方法在ContentProvider创建后会被调用，当其他应用程序的第一次访问ContentProvider时，该ContentProvider会被创建出来，并立即回调该onCreate()方法</li>
<li>public Uri insert(Uri uri, ContentValues values);根据Uri插入Values对应的数据</li>
<li>public int delete(Uri uri, String selection, String[] selectionArgs);根据Uri删除select条件所匹配的全部记录</li>
<li>public int update(Uri uri, ContentValues values, String selection, String[] selectionArgs):根据Uri修改select条件所匹配的全部记录</li>
<li>public Cursor query(Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder):根据Uri查询出select条件所匹配的全部记录，其中projection就是一个列名列表，表明只选择出指定的数据列</li>
<li>public String getType(Uri uri):返回当前Uri所代表的数据的MIME类型。如果该Uri对应数据可能包括多条记录，那么MIME类型字符串应该以vnd.android.cursor.dir开头，如果该Uri对应的数据只包含一条记录，那么返回MIME字符串应该以vnd.android.cursor.item开头</li>
</ol>
<p>形如<code>content://org.crazyit.providers.dictProvider/words</code>的Uri可分为3个部分</p>
<ol>
<li>content:// 这个部分是Android所规定的，是固定的</li>
<li>org.crazyit.providers.dictProvider:这个部分就是ContentProvider的authority，系统就是由这个部分来找到操作哪个ContentProvider。只要访问指定的ContentProvider，这个部分总是固定的</li>
<li>words:资源部分(或者是数据部分)，当访问者需要访问不同资源时，这个部分是动态改变的</li>
</ol>
<p>Context提供了如下方法来获取ContentResolver对象<code>getContentResolver()</code>，ContentResolver和ContentProvider的方法对应，支持的方法有：</p>
<ol>
<li>insert(Uri uri, ContentValues values);</li>
<li>delete(Uri uri, String selection, String[] selectionArgs);</li>
<li>update(Uri uri, ContentValues values, String selection, String[] selectionArgs):</li>
<li>query(Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder):</li>
</ol>
<blockquote>
<p>一般来说，ContentProvider是单例模式的，当多个应用程序通过ContentResolver来操作ContentProvider提供的数据时，ContentResolver调用操作将会委托同一个ContentProvider处理</p>
</blockquote>
<pre><code>public final class Words {
    //定义该ContentProvider的Authority
    public static final String AUTHORITY = @&quot;org.crazyit.providers.dictProvider&quot;;
    //定义一个静态内部类
    public static final class Word implements BaseColumn {
        public final String _ID = &quot;_id&quot;;
        public final String WORD = &quot;word&quot;;
        public final String DETAIL = &quot;detail&quot;;
        //定义该Content提供服务的两个Uri
        public final Uri DICT_CONTENT_URI = Uri.parse(&quot;content://&quot;+AUTHORITY+&quot;/words&quot;);
        public final Uri WORD_CONTENT_URI = Uri.parse(&quot;content://&quot;+AUTHORITY+&quot;/word&quot;);
    }
}
public class DictProvider extends ContentProvider {
    private static UriMatcher matcher = new UriMatcher(UriMatcher.NO_MATCH);
    private static final int WORDS = 1;
    private static final int WORD = 2;
    private MyDatabaseHelper dbOpenHelper;
    static {
        matcher.addURI(Words.AUTHORITY, &quot;words&quot;, WORDS);
        matcher.addURI(Words.AUTHORITY, &quot;word/#&quot;, WORD);
    }
    public boolean onCreate() {
        dbOpenHelper = new MyDataBaseHelper(this.getContext(), &quot;myDict.db3&quot;, 1);
        return true;
    }
    public Uri insert(Uri uri, ContentValues values) {
        SQLiteDatabase db = dbOpenHelper.getReadableDatabase();
        long rowId = db.insert(&quot;dict&quot;, Words.Word._ID, values);
        if (rowId &gt; 0) {
            Uri wordUri = ContentUris.withAppendedId(uri, rowId);
            getContext().getContentResolver().notifyChange(wordUri, null);
            return wordUri;
        }
        return null;
    }
    public int delete(Uri uri, String selection, String[] selectionArgs) {
        SQLiteDatabase db = dbOpenHelper.getReadableDatabase();
        int num = 0;
        switch (matcher.match(uri)) {
            case WORDS:
                num = db.delete(&quot;dict&quot;, selection, selectionArgs);
                break;
            case WORD:
                long id = ContentUris.parseId(uri);
                String where = Words.Word._ID+&quot;=&quot;+id;
                if (selection != null &amp;&amp; !selection.equals(&quot;&quot;)) {
                    where = where + &quot; and &quot; + selection;
                }
                num = db.delete(&quot;dict&quot;, where, selectionArgs);
                break;
            default:
                throw new IllegalArgumentException(&quot;未知Uri:&quot;+uri);
        }
        getContext().getContentResolver().nofityChange(uri, null);
        return num;
    }
    ...
}
public class DictResolver extends Activity {
    ContentResolver contentResolver;
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.main);
        contentResolver = getContentResolver();
        insert.setOnClickListener(new OnClickListener() {
            public void onClick(View source) {
                ContentValues values = new ContentValues();
                values.put(Words.Word.WORD, word);
                values.put(Words.Word.DETAIL, detail);
                contentResolver.insert(Words.Word.DICT_CONTENT_URI, values);
            }
        });
    }
}
</code></pre><p>在上边例子中，为了确定ContentProvider实际能匹配的Uri，以及确定每个方法中Uri参数所操作的数据，Android系统提供了UriMatcher工具类，该类提供了两个方法：</p>
<ol>
<li>void addURI(String authority, String path, int code):向UriMatcher对象注册Uri，其中authority和path组成一个Uri，Code则代表该Uri对应的标识码</li>
<li>int match(Uri):根据前面注册的Uri来判断指定Uri对应的标识码，如果没有匹配，则返回-1</li>
</ol>
<p>Android还提供了一个ContentUris工具类，它是一个操作Uri字符串的工具类，它提供了两个方法：</p>
<ol>
<li>withAppendedId(uri, id):用于为路径加上ID部分</li>
<li>parseId(uri):用于从指定Uri中解析出包含的ID值</li>
</ol>
<p>有些时候，只有第一个和第二个应用程序知道共享的数据发生变化，第三个应用如果想知道，就需要监听ContentProvider所共享数据的改变，这就需要利用ContentObserver了。监听ContentProvider数据改变的监听器需要继承ContentObserver类，并重写该基类所定义的onChange(boolean selfChange)方法，当它所监听的ContentProvider的数据发生改变时，该onChange方法将会被触发。</p>
<p><code>getContext().getContentResolver().notifyChange(uri, null)</code>;null可以为ContentObserver实例，表示当前应用监听器数据的变化；这行代码可以通知所有注册在该Uri上的监听者，该ContentProvider所共享的数据发生了改变</p>
<p>为了监听指定ContentProvider的数据变化，需要通过ContentResolver向指定Uri注册ContentObserver监听器。ContentObserver提供了如下方法来注册监听器：</p>
<p><code>registerContentObserver(Uri uri, boolean notifyForDescendents, ContentObserver observer)</code>：uri指该监听器所监听的ContentProvider的Uri；notifyForDescendents如果为true，则子uri也会被监听，如果为false，则不会监听子uri；observer则是监听器实例</p>
<pre><code>getContentObserver().registerContentObserver(Uri.parse(&quot;content://&quot;+AUTHORITY+&quot;/words&quot;), true, new DictObserver(new Handler()));

public class Monitor extends Activity {
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.main);
        getContentResolver().registerContentObserver(Uri.parse(&quot;content://&quot;+AUTHORITY+&quot;/words&quot;), true, new DictObserver(new Handler()));
    }

    public final class DictObserver extends ContentObserver {
        public DictObserver(Handler handler) {
            super(hander);
        }
        public void onChange(boolean selfChange) {
            ...
        }
    }
}
</code></pre><h2 id="Service与BroadcastReceiver"><a href="#Service与BroadcastReceiver" class="headerlink" title="Service与BroadcastReceiver"></a>Service与BroadcastReceiver</h2><p>Service是Android四大组件中与Activity最相似的组件，他们都代表可执行的程序，Service与Activity的区别在于，Service一直在后台运行，它没有用户界面，所以绝不会到前台来。一旦Service被启动起来之后，它就与Activity一样。它完全具有自己的生命周期。</p>
<p>本章还将向读者介绍BroadcastReceiver组件。BroadcastReceiver组件就像一个全局的事件监听器，只不过它用于监听系统发出的Broadcast。通过BroadcastReceiver，即可在不同应用程序之间进行通信。</p>
<h3 id="10-1-Service简介"><a href="#10-1-Service简介" class="headerlink" title="10.1 Service简介"></a>10.1 Service简介</h3><p>就像开发Activity需要两个步骤一样，开发Service也需要两个步骤：</p>
<ol>
<li>定义一个继承Service的子类</li>
<li>在AndroidManifest.xml文件中配置该Service</li>
</ol>
<p>Service与Activity还有一点相似之处，它们都是从Context派生出来的，因此它们都可以调用Context里定义的如getResource()，getContentResolver()等方法</p>
<p>与Activity相似的是，Service中也定义了生命周期方法，如下所示：</p>
<ol>
<li>abstract IBinder onBind(Intent intent):该方法是Service子类必须实现的方法，该方法返回一个IBinder对象，应用程序可通过该对象与Service组件通信</li>
<li>void onCreate():当该Service第一次被创建时将立即回调该方法</li>
<li>void onDestroy():当该Service被关闭之前将会回调该方法</li>
<li>void onStartCommand(Intent intent, int flags, int startId):该方法的早期版本时void onStart(Intent intent, int startId)，每次客户端调用startService(Intent)方法启动该Service时都会回调该方法</li>
<li>boolean onUnbind(Intent intent):当该Service上绑定的所有客户端都断开连接时将会回调该方法</li>
</ol>
<p>定义了上边的Service之后，接下来需要在AndroidManifest.xml文件中配置该Service</p>
<pre><code>&lt;service android:name=&quot;.FirstService&quot;&gt;
    &lt;intent-filter&gt;
        &lt;action android:name=&quot;org.crazyit.service.FIRST_SERVICE&quot;&gt;
    &lt;/intent-filter&gt;
&lt;/service&gt;
</code></pre><p>当该Service开发完成之后，接下来就可在程序中运行该Service了，Android系统中运行Service有如下两种方式</p>
<ol>
<li>通过Context的startService()方法，通过该方法启动Service，访问者与Service之间没有联系，即使访问者退出了，Service仍然运行</li>
<li>通过Context的bindService()方法，使用该方法启动Service，访问者与Service绑定在了一起，访问者一旦退出，Service也就终止</li>
</ol>
<p>当程序通过startService()和stopService()启动，关闭Service时，Service与访问者之间基本上不存在太多的数据关联，因此Service和访问者之间也无法进行通信、数据交换。</p>
<p>如果Service和访问者之间需要进行方法调用或者数据交换，则应使用bindService()和unbindService()方法启动、关闭服务。</p>
<p>Context的bindService()方法的完整方法签名为：bindService(Intent service, ServiceConnection conn, int flags)，该方法的三个参数的解释如下：</p>
<ol>
<li>service：该参数通过Intent指定要启动的Service</li>
<li>conn：该参数是一个ServiceConnection对象，该对象用于监听访问者与Service之间的连接情况。当访问者与Service之间连接成功时将回调该ServiceConnection对象的onServiceConnected(ComponentName name, IBinder service)方法，当访问者与Service断开连接时将回调该ServiceConnection对象的onServiceDisconnected(ComponentName, name)方法</li>
<li>flags：指定绑定时是否自动创建Service(如果Service还未创建)。该参数可指定为0（不自动创建）或BIND_AUTO_CREATE（自动创建）</li>
</ol>
<blockquote>
<p>注意到ServiceConnection对象的onServiceConnected方法中有一个IBinder对象，该对象即可实现与被绑定Service之间的通信</p>
</blockquote>
<pre><code>public class BindService extends Service {
    private MyBinder binder = new MyBinder();
    public class MyBinder extends Binder {
        public int getXxx() {
            return ...
        }
    }
    public IBinder onBind(Intent intent) {
        return binder;
    }
    public void onCreate() {
        super.onCreate();
    }
    public boolean onUnbind(Intent intent) {
        return truel
    }
    public void onDestory() {
        super.onDestory();
    }
}

public class MainActivity extends Activity {
    BindService.MyBinder binder;
    private ServiceConnection conn = new ServiceConnection() {
        public void onServiceConnected(componentName name, IBinder service) {
            binder = (BindService.MyBinder)service;
        }
        public void onServiceDisconnected(ComponentName name) {
            ...
        }
        public void onCreate(Bundle savedInstanceState) {
            super.onCreate(savedInstanceState);
            setContentView(R.layout.main);
            final Intent intent = new Intent();
            intent.setAction(&quot;org.crazyit.service.BIND_SERVICE&quot;);
            bindButton.setOnClickListener(new OnClickListener(){
                public void onClick(View Source) {
                    bindService(intent, conn, Service.BIND_AUTO_CREATE)
                }
            });
            unbindButton.setOnClickListener(new OnClickListener(){
                public void onClick(View source) {
                    unbindService(conn);
                }
            });
            getDataButton.setOnClickListener(new OnclickListener(){
                public void onClick(View source) {
                    print(binder.getXxx());
                }
            });
        }
    }
}
</code></pre><p>通过前面两个示例，读者应该已经大致明白Service的生命周期了。随着应用程序启动Service方式不同，Service的生命周期也略有差异</p>
<ol>
<li>如果应用程序通过startService方法来启动Service，Service的生命周期是：启动-onCreate-onStart-运行-onDestory</li>
<li>如果应用程序通过bindService方法来启动Service，Service的生命周期是：启动-onCreate-onBind-交互-onUnbind-onDestory</li>
</ol>
<h3 id="10-2-跨进程调用Service-AIDL服务"><a href="#10-2-跨进程调用Service-AIDL服务" class="headerlink" title="10.2 跨进程调用Service(AIDL服务)"></a>10.2 跨进程调用Service(AIDL服务)</h3><p>Android用AIDL(Android Interface Definition Language)来定义远程接口，AIDL的语法与Java接口很相似，但存在一些差异</p>
<ol>
<li>AIDL定义接口的源代码必须以.aidl结尾</li>
<li><p>AIDL接口中用到的数据类型，除了基本类型、String、List、Map、CharSequence之外，其他类型全部都需要导包，及时它们在同一个包中也需要导包</p>
<pre><code>// ICat.aidl
package service.crazyit.org.aidlservice;
interface ICat {
    void basicTypes(int anInt, long aLong, boolean aBoolean, float aFloat,
            double aDouble, String aString);
    String getColor();
    double getWeight();
}

//AidlService.java
public class AidlService extends Service {
    private CatBinder catBinder;
    public class CatBinder extends ICat.Stub {
        @Override
        public double getWeight() throws RemoteException {
            return 100;
        }
    }
    @Override
    public IBinder onBind(Intent intent) {
        return catBinder;
    }
    @Override
    public void onCreate() {
        super.onCreate();
        catBinder = new CatBinder();
    }
    @Override
    public void onDestroy() {
        super.onDestroy();
    }
}

//MainActivity.java
public class MainActivity extends AppCompatActivity {
    private ICat catService;
    private ServiceConnection conn = new ServiceConnection() {
        @Override
        public void onServiceConnected(ComponentName name, IBinder service) {
            catService = ICat.Stub.asInterface(service);
        }
        @Override
        public void onServiceDisconnected(ComponentName name) {
            catService = null;
        }
    };
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        final Intent intent = new Intent();
        intent.setAction(&quot;org.crazyit.aidl.action.AIDL_SERVICE&quot;);
        bindService(intent, conn, Service.BIND_AUTO_CREATE);
        new Thread(new Runnable() {
            @Override
            public void run() {
                try {
                    Thread.sleep(5000);
                    Log.d(&quot;frand&quot;, catService.getWeight()+&quot;&quot;);
                } catch (RemoteException e) {
                    e.printStackTrace();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }).start();
    }
}
</code></pre></li>
</ol>
<h3 id="10-3-电话管理器-TelephonyManager"><a href="#10-3-电话管理器-TelephonyManager" class="headerlink" title="10.3 电话管理器(TelephonyManager)"></a>10.3 电话管理器(TelephonyManager)</h3><p>TelephonyManager是一个管理手机通话状态、电话网络信息的服务类，该类提供了大量的getXxx()方法来获取电话网络的相关信息，在程序中获取TelephonyManager十分简单，只要调用如下代码即可<code>TelephonyManager tManager = (TelephonyManager)getSystemService(Context.TELEPHONY_SERVICE);</code>，接下来就可以通过TelephonyManager获取相关信息或者进行相关操作了</p>
<p>getDeviceId()/getDeviceSoftwareVersion()/getNetworkOperator()/getNetworkOperatorName()/getPhoneType()/getCellLocation()/getSimCountryIso()/getSimSerialNumber()/getSimState()等</p>
<pre><code>//监听手机来电，如果是黑名单，则自动挂断
public class MonitorPhone extends Activity {
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.main);
        TelephonyManager tManager = (TelephonyManager)getSystemService(Context.TELEPHONY_SERVICE);
        PhoneStateListener listener = new PhoneStateListener() {
            public void onCallStateChanged(int state, String incomingNumber) {
                switch(state) {
                    case TelephonyManager.CALL_STATE_IDLE:
                        break;
                    case TelephonyManager.CALL_STATE_OFFHOOK:
                        break;
                    case TelephonyManager.CALL_STATE_RINGING:
                        if (isBlock(incomingNumber)) {
                            Method method = Class.forName(&quot;android.os.ServiceManager&quot;).getMethod(&quot;getService&quot;, String.class);
                            IBinder binder = (IBinder)method.invoke(null, new Object[]{TELEPHONY_SERVICE});
                            ITelephony telephony = ITelephony.Stub.asInterface(binder);
                            telephony.endCall();
                        }
                        break;
                    default:
                        break;
                }
            }
        };
        tManager.listen(listener, PhoneStateListener.LISTEN_CALL_STATE);
    }
}
</code></pre><h3 id="10-4-短信管理器"><a href="#10-4-短信管理器" class="headerlink" title="10.4 短信管理器"></a>10.4 短信管理器</h3><p>SmsManager是Android提供的另一个非常常见的服务，SmsManager提供了系列sendXxxMessage()方法用于发送短信，不过就现在实际应用来看，短信通常都是普通的文本内容，也就是调用sendTextMessage()方法进行发送即可</p>
<pre><code>SmsManager sManager = SmsManager.getDefault();
PendingIntent pi = PendingIntent.getActivity(SendSms.this, 0, new Intent(), 0);
sManager.sendTextMessage(number, null, content, pi, null);

&lt;uses-permission android:name=&quot;android.permission.SEND_SMS&quot; /&gt;
</code></pre><h3 id="10-5-音频管理器-AudioManager"><a href="#10-5-音频管理器-AudioManager" class="headerlink" title="10.5 音频管理器(AudioManager)"></a>10.5 音频管理器(AudioManager)</h3><p>在某些时候，程序需要管理系统音量，或者直接让系统静音，这就可以借助于Android提供的AudioManager来实现。程序一样是调用getSystemService()方法来获取系统的音频管理器。接下来就可调用AudioManager的方法来控制手机音频了。</p>
<ul>
<li><p>adjustStreamVolume(int streamType, int direction, int flags):调整手机指定类型的声音。其中第一个参数streamType指定声音类型，该参数可接受如下几个值</p>
<ol>
<li>STREAM_ALARM:手机闹铃的声音</li>
<li>STREAM_DTMF:DTMF音调的声音（键盘音）</li>
<li>STREAM_MUSIC:手机音乐的声音</li>
<li>STREAM_NOTIFICATION:系统提示的声音</li>
<li>STREAM_RING:电话铃声的声音</li>
<li>STREAM_SYSTEM:手机系统的声音</li>
<li>STREAM_VOICE_CALL:语言电话的声音</li>
</ol>
</li>
</ul>
<pre><code>第二个参数指定对声音进行增大、还是减少；第三个参数时调整声音时的标志，例如指定FLAG_SHOW_UI，则指定调整声音时显示音量进度条。
</code></pre><ul>
<li>SetMicrophoneMute(boolean on):设置是否让麦克风静音</li>
<li>setMode(int mdoe):设置声音模式，可设置的值有NORMAL，RINGTONE和IN_CALL</li>
<li><p>setRingerMode(int ringerMode):设置手机的电话铃声模式，支持如下几个属性</p>
<ul>
<li>RINGER_MODE_NORMAL:正常的手机铃声</li>
<li>RINGER_MODE_SILENT:手机铃声静音</li>
<li>RINGER_MODE_VIBRATE:手机振动</li>
</ul>
</li>
<li><p>setSpeakerPhoneOn(boolean on):设置是否打开扩音器</p>
</li>
<li>setStreamMute(int streamType, boolean state):将手机的指定类型的声音调整为静音，其中streamType和adjustStreamVolume方法中第一个参数的意义相同</li>
<li>setStreamVolume(int streamType, int index, int flags):直接设置手机的指定类型的音量</li>
</ul>
<p><code>AudioManager aManager = (AudioManager)getSystemService(Service.AUDIO_SERVICE);</code></p>
<h3 id="10-6-振动器"><a href="#10-6-振动器" class="headerlink" title="10.6 振动器"></a>10.6 振动器</h3><p>系统获取Vibrator也是调用Context的getSystemService()方法即可，接下来就可调用vibrator的方法来控制手机振动了，其使用方法比较简单，只有三个简单的方法来控制手机振动：</p>
<ol>
<li>void vibrate(long milliseconds):控制手机振动多少毫秒</li>
<li>void vibrate(long[] pattern, int repeat):指定手机以pattern指定的模式振动</li>
<li><p>cancel():关闭手机振动</p>
<pre><code>Vibrator vibrator = (Vibrator)getSystemService(Service.VIBRATOR_SERVICE);
vibrator.vibrate(2000);
&lt;uses-permission android:name=&quot;android.permission.VIBRATE&quot; /&gt;
</code></pre></li>
</ol>
<h3 id="10-7-手机闹钟服务-AlarmManager"><a href="#10-7-手机闹钟服务-AlarmManager" class="headerlink" title="10.7 手机闹钟服务(AlarmManager)"></a>10.7 手机闹钟服务(AlarmManager)</h3><p>AlarmManager通常的用途就是用来开发手机闹钟，但实际上它的作用不止于此。它的本质是一个全局的定时器，AlarmManager可在指定时间或者指定周期启动其他组件(包括Activity、Service、BroadcastReceiver)</p>
<p>AlarmManager不仅可用于开发闹钟应用，还可以作为一个全局定时器使用，Android应用中的程序也是通过Context的getSystemService()方法来获取AlarmManager对象，一旦程序获取了AlarmManager对象之后，就可调用它的如下方法来设置定时启动指定组件：</p>
<ul>
<li><p>void set(int type, long triggerAtTime, PedingIntent operation):设置在triggerAtTime时间启动由operation参数指定的组件。其中第一个参数指定定时服务的类型，该参数可接受如下值：</p>
<ul>
<li>ELAPSED_REALTIME:指定从现在开始时间过了一定时间后启动operation所对应的组件</li>
<li>ALAPSED_REALTIME_WAKEUP:即使系统关机也会执行operation所对应的组件</li>
<li>RTC:指定当系统调用System.currentTimeMillis()方法返回值与triggerAtTime相等时启动operation所对应的组件</li>
<li>RTC_WAKEUP:即使系统关机也会执行operation所对应的组件</li>
</ul>
</li>
<li><p>void setInexactRepeating(int type, long triggerAtTime, long interval, PendingIntent operation):设置一个非精确的周期性任务。例如我们设置Alarm每个小时启动一次，但系统并不一定在每个小时的开始启动Alarm服务</p>
</li>
<li>void setRepeating(int type, long triggerAtTime, long interval, PendingIntent operation):设置一个周期性执行的定时任务</li>
<li>void cancel(PedingIntent operation):取消AlarmManager的定时任务</li>
</ul>
<pre><code>public class AlarmChangeWallpaper extends Activity {
    public void onCreate(Bundle savedInstance) {
        super.onCreate(savedInstance);
        setContentView(R.layout.main);
        AlarmManager aManager = (AlarmManager)getSystemService(Service.ALARM_SERVICE);
        Intent intent = new Intent(AlarmChangeWallpaper.this, ChangeService.class);
        final PendingIntent pi = PendingIntent.getService(AlarmChangeWallpaper.this, 0, intent, 0);
        aManager.setRepeating(AlarmManager.RTC_WAKEUP, 0, 5000, pi);
    }
}
public class ChangeService extends Service {
    WallpaperManager wManager;
    public void onCreate() { 
        super.onCreate();
        wManager = WallpaperManager.getInstance(this);
    }
    public void onStart(Intent intent, int startId) {
        wManager.setResource(wallpapers[count++]);
        super.onStart(intent, startId);
    }
    public void onBind(Intent intent) {
        return null;
    }
}
&lt;uses-permision android:name=&quot;android.permission.SET_WALLPAPER&quot; /&gt;
</code></pre><h3 id="10-8-广播消息"><a href="#10-8-广播消息" class="headerlink" title="10.8 广播消息"></a>10.8 广播消息</h3><p>Android系统的四大组件还有一种BroadcastReceiver，这种组件本质上就是一种全局监听器，用于监听系统全局的广播消息。由于BroadcastReceiver是一种全局的监听器，因此它可以非常方便地实现系统中不同组件之间的通信。</p>
<p>BroadcastReceiver用于接收程序（包括用户开发的程序和系统内建的程序）所发出的Broadcast Intent，与应用程序启动Activity，Service相同的是，程序启动BroadcastReceiver也只需要两步：</p>
<ol>
<li>创建需要启动的BroadcastReceiver的Intent</li>
<li>调用Context的sendBroadcast()或sendOrderedBroadcast()方法来启动指定的BroadcastReceiver</li>
</ol>
<p>当程序发出一个Broadcast Intent之后，所有匹配该Intent的BroadcastReceiver都有可能被启动</p>
<p>与Activity、Service具有完整生命周期不同的是，BroadcastReceiver本质上只是一个系统级的监听器，它专门负责 监听各程序所发出的Broadcast。与前面介绍的各种OnXXXListener不同的是，它是一个系统级的监听器，它有自己的进程，当程序退出时，只要存在与之匹配的Intent被广播出来，BroadcastReceiver总会被激发。</p>
<p>一旦实现了BroadcastReceiver的onReceive方法，接下来就应该指定该BroadcastReceiver能匹配的Intent，此时有两种方式：</p>
<ol>
<li><p>使用代码进行指定，调用BroadcastReceiver的Context的registerReceiver(BroadcastReceiver receiver, IntentFilter filter)方法指定:</p>
<pre><code>IntentFilter filter = new IntentFilter(&quot;android.provider.telephony.SMS_RECEIVERD&quot;);
IncomingSMSReceiver receiver = new IncomingReceiver();
register(receiver, filter);
</code></pre></li>
<li><p>在AndroidManifest.xml文件中配置，代码如下:</p>
<pre><code>&lt;receiver android:name=&quot;.IncomingReceiver&quot; &gt;
    &lt;intent-filter&gt;
        &lt;action android:name=&quot;android.provider.telephoy.SMS_RECEIVED&quot; /&gt;
    &lt;/intent-filter&gt;
&lt;/receiver&gt;
</code></pre></li>
</ol>
<p>每次系统broadcast事件发生之后，系统就会创建对应的BroadcastReceiver实例，并自动触发它的onReceive方法，onReceive方法执行完后，BroadcastReceiver的实例就会被销毁。如果BroadcastReceiver的onReceive方法不能在10秒内执行完成，Android会认为该程序无响应。所以不要在BroadcastReceiver的onReceive方法里执行一些耗时的操作，否则会弹出ANR（Application No Response）的对话框</p>
<p>在程序中发送广播十分简单，只要调用Context的sendBroadcast(Intent intent)方法即可，这条广播将会启动intent参数所对应的BroadcastReceiver。</p>
<p>Broadcast被分为如下两种：</p>
<ol>
<li>Normal Broadcast(普通广播):这种广播完全是异步的，可以在同一时刻被所有接收者接收到，消息传递的效率比较高。但缺点是接收者不能将处理结果传递给下一个接收者，并且无法终止Broadcast Intent的传播</li>
<li><p>Ordered Broadcast(有序广播):这种广播的接收者将按预先声明的优先级依次接收Broadcast。优先级别声明在&lt;intent-filter…/&gt;元素的android:priority属性中，数越大优先级别越高，取值范围为-1000~1000之间，优先级别也可以调用IntentFilter对象的setPriority()进行设置。Ordered Broadcast接收者可以调用BroadcastReceiver的abordBroadcast()方法终止Broadcast Intent的传播，Broadcast Intent一旦终止，后面的接收者就无法接收到Broadcast。另外，Ordered Broadcast的接收者可以将数据传递给下一个接收者</p>
<pre><code>//发送广播
Intent intent = new Intent();
intent.setAction(&quot;org.crazyit.action.CRAZY_BROADCAST&quot;);
sendOrderedBroadcast(intent, null);

//第一个BroadcastReceiver
Bundle bundle = new Bundle();
bundle.putString(&quot;first&quot;, &quot;第一个BroadcastReceiver存入的消息&quot;);
setResultExtra(bundle);
abortBroadcast();
&lt;receiver android:name=&quot;.MyReceiver&quot; &gt;
    &lt;intent-filter android:priority=&quot;20&quot;&gt;
        &lt;action android:name=&quot;org.crazyit.action.CRAZY_BROADCAST&quot; /&gt;
    &lt;/intent-filter&gt;
&lt;/receiver&gt;

//第二个BroadcastReceiver
Bundle bundle = getResultExtra(true);
String first = bundle.getString(&quot;first&quot;);
</code></pre></li>
</ol>
<h3 id="10-9-接收系统广播消息"><a href="#10-9-接收系统广播消息" class="headerlink" title="10.9 接收系统广播消息"></a>10.9 接收系统广播消息</h3><p>如果应用需要在系统特点时刻执行某些操作，就可以通过监听系统广播来实现。Android的大量系统事件都会对外发送标准广播。下面是Android常见的广播Action常量</p>
<ul>
<li>ACTION_TIME_CHANGED:时间改变</li>
<li>ACTION_DATE_CHANGED:日期改变</li>
<li>ACTION_TIMEZONE_CHANGED:时区改变</li>
<li>ACTION_BOOT_COMPLETED:启动完成</li>
<li>ACTION_PACKAGE_ADDED:添加包</li>
<li>ACTION_PACKAGE_CHANGED:包被删除</li>
<li>ACTION_PACKAGE_REMOVED:包被删除</li>
<li>ACTION_PACKAGE_RESTARTED:包被重启</li>
<li>ACTION_PACKAGE_DATA_CLEARED:包数据被清空</li>
<li>ACTION_BATTERY_CHANGED:电池电量改变</li>
<li>ACTION_BATTERY_LOW:电池电量低</li>
<li>ACTION_POWER_CONNECTED:系统连接电源</li>
<li>ACTION_POWER_DISCONNECTED:系统断开电源</li>
<li>ACTION_SHUTDOWN:系统被关闭</li>
</ul>
<h2 id="多媒体应用开发"><a href="#多媒体应用开发" class="headerlink" title="多媒体应用开发"></a>多媒体应用开发</h2><h3 id="11-1-音频和视频的播放"><a href="#11-1-音频和视频的播放" class="headerlink" title="11.1 音频和视频的播放"></a>11.1 音频和视频的播放</h3><p>Android提供了简单的API来播放音频、视频：MediaPlayer；使用MediaPlayer十分简单，当程序控制MediaPlayer对象装载音频完成以后，程序可以调用MediaPlayer的如下三个方法进行播放控制：</p>
<ul>
<li>start():开始或恢复播放</li>
<li>stop():停止播放</li>
<li>pause():暂停播放</li>
</ul>
<p>为了让MediaPlayer来装载指定音频文件，MediaPlayer提供了如下简单的静态方法：</p>
<ul>
<li>static MediaPlayer create(Context context, Uri uri):从指定Uri来装载音频文件，并返回对象</li>
<li>static MediaPlayer create(Context context, int resid):从resid资源ID对应的资源装载音频文件并返回</li>
</ul>
<p>如果程序需要使用MediaPlayer循环播放多个音频文件，使用MediaPlayer的静态create方法就不太合适了，此时可通过MediaPlayer的setDataSource()方法来装载指定的音频文件</p>
<ul>
<li>void setDataSource(String path/FileDescriptor fd):指定装载path路径或fd所代表的文件</li>
<li>void setDataSource(FileDescriptor fd, long offset, long length):指定fd文件的offset开始length长度的文件内容</li>
<li>void setDataSource(Context context, Uri uri):指定装载uri所代表的文件</li>
</ul>
<p>执行上面所示的setDataSource方法之后，MediaPlayer并未真正去装载那些文件，还需要调用MediaPlayer的prepare()方法去准备，所谓准备，就是让MediaPlayer真正去装载音频文件</p>
<p>除此之外，MediaPlayer还提供了一些绑定事件监听器的方法，用于监听MediaPlayer播放过程中所发生的特定事件，绑定事件监听器的方法如下：</p>
<ul>
<li>setOnCompletionListener(MediaPlayer.OnCompletionListener listener):</li>
<li>setOnErrorListener(MediaPlayer.OnErrorListener listener):</li>
<li>setOnPreparedListener(MediaPlayer.OnPreparedListener listener):</li>
<li>setOnSeekCompleteListener(MediaPlayer.OnSeekCompleteListener listener):</li>
</ul>
<p>如果应用程序经常需要播放密集、短促的音效，这是还用MediaPlayer就显得有些不合适了。MediaPlayer存在如下缺点：</p>
<ol>
<li>占用资源较多，延时时间较长</li>
<li>不支持多个音效同时播放</li>
</ol>
<p>为了解决这个问题，Android提供了SoundPool来播放音效，SoundPool使用音效池的概念来管理多个短促的音效，它与MediaPlayer相比，占用资源量低延时更小，而且还支持自行设置声音的品质、音量、缩放比率等参数。它的构造器如下：</p>
<ul>
<li>SoundPool(int maxStreams, int streamType, int srcQuality):第一个参数指定支持多少个声音，第二个参数指定声音类型，第三个参数指定声音品质</li>
</ul>
<p>一旦得到了SoundPool对象之后，接下来就可调用SoundPool的多个重载的load方法来加载声音了，SoundPool提供了如下4个load方法</p>
<ul>
<li>int load(Context context, int resId, int priority):</li>
<li>int load(FileDescriptor fd, long offset, long length, int priority)</li>
<li>int load(AssetFileDescriptor afd, int priority)</li>
<li>int load(String path, int priority)</li>
</ul>
<p>上面4个方法都有一个priority参数，该参数目前还没有任何作用，Android建议将该参数设为1，保持和未来的兼容性；上面的4个方法加载声音之后都会返回该声音的ID，以后程序就可以通过该声音的ID来播放指定声音，SoundPool提供的播放指定声音的方法如下：</p>
<ul>
<li>int play(int soundID, float leftVolume, float rightVolume, int priority, int loop, float rate):该方法的第一个参数指定播放哪个声音，leftVolume和rightVolume指定左、右的音量，priority指定播放声音的优先级，数值越大，优先级越高；loop指定是否循环，0为不循环，-1为循环；rate指定播放的比率，数值可从0.5到2，1为正常比率</li>
</ul>
<p>为了更好的管理SoundPool所加载的每个声音的ID，程序一般会使用一个HashMap&lt;Integer, Integer&gt;对象来管理声音</p>
<pre><code>SoundPool soundPool = new SoundPool(10, AudioManager.STREAM_SYSTEM, 5);
HashMap soundMap = new HashMap&lt;Integer, Integer&gt;();
soundMap.put(1, soundPool.load(this, R.raw.bomb, 1));
btn.setOnClickListener(new OnClickListener(){
    public void onClick(View v) {
        soundPool.play(soundMap.get(1), 1, 1, 0, 0, 1);
    }
});
</code></pre><p>SoundPool虽然可以一次性加载多个声音，但由于内存限制，因此更应该避免使用SoundPool来播放歌曲或者做游戏背景音乐，只有那些短促、密集的声音才考虑使用SoundPool进行播放</p>
<p>使用VideoView播放视频的步骤如下：</p>
<pre><code>&lt;VideoView
    android:id=&quot;@+id/video&quot;
    android:layout_width=&quot;fill_parent&quot;
    android:layout_height=&quot;fill_parent&quot; /&gt;

VideoView videoView = (VideoView)findViewById(R.id.video);
MediaController mediaController = new MediaController(this);
File video = new File(&quot;/mnt/sdcard/movie.mp4&quot;);
if (video.exist()) {
    videoView.setVideoPath(video.getAbsolutePath());
    videoView.setMediaController(mediaController);
    mediaController.setMediaPlayer(videoPlayer);
    videoView.requestFocus();
}    
</code></pre><h3 id="11-2-使用MediaRecorder录制音频"><a href="#11-2-使用MediaRecorder录制音频" class="headerlink" title="11.2 使用MediaRecorder录制音频"></a>11.2 使用MediaRecorder录制音频</h3><p>为了在Android应用中录制音频，Android提供了MediaRecorder类，使用MediaRecorder录制音频的过程很简单，按如下步骤进行即可：</p>
<ul>
<li>创建MediaRecorder对象</li>
<li>调用MediaRecorder对象的setAudioSource()方法设置声音来源，一般传入MediaRecorder.AudioSource.MIC参数指定录制来自麦克风的声音</li>
<li>调用MediaRecorder对象的setOutputFormat设置所录制的音频文件格式</li>
<li>调用MediaRecorder对象的setAudioEncoder()、setAudioEncodingBitRate(int bitRate)、setAudioSamplingRate()设置所录制的声音的编码格式、编码位率、采样率等</li>
<li>调用MediaRecorder的setOutputFile(String path)方法设置录制音频文件的保存位置</li>
<li>调用MediaRecorder的prepare()方法准备开始录制</li>
<li>调用MediaRecorder的start()方法开始录制</li>
<li><p>调用MediaRecorder的stop()方法停止录制，并调用release()方法释放资源</p>
<pre><code>File soundFile = new File(&quot;/file/sound.amr&quot;);
MediaRecorder mediaRecorder = new MediaRecorder();
mediaRecorder.setAudioSource(MediaRecorder.AudioSource.MIC);
mediaRecorder.setOutputFormat(MediaRecorder.OutputFormat.THREE_GPP);
mediaRecorder.setAudioEncoder(MediaRecorder.AudioEncoder.ARM_NB);
mediaRecorder.setOutputFile(soundFile.getAbsolutePath);
mediaRecorder.prepare();
mediaRecorder.start();
&lt;uses-permission android:name=&quot;android.permission.RECORD_AUDIO&quot; /&gt;
</code></pre></li>
</ul>
<h3 id="11-3-控制摄像头拍照和录视频短片"><a href="#11-3-控制摄像头拍照和录视频短片" class="headerlink" title="11.3 控制摄像头拍照和录视频短片"></a>11.3 控制摄像头拍照和录视频短片</h3><p>使用MediaRecorder拍照代码：</p>
<pre><code>SurfaceView surfaceView = (SurfaceView)findViewById(R.id.sufaceView);
SufaceHolder surfaceHolder = surfaceView.getHolder();
Camera camera = Camera.open();
Camera.Parameters parameters = camera.getParameters();
parameters.setPreviewSize(screenWidth, screenHeight);
parameters.setPreviewFrameRate(4);
parameters.setPictureFormat(PixelFormat.JPEG);
parameters.set(&quot;jpeg-quality&quot;, 85);
parameters.setPictureSize(screenWidth, screenHeight);
camera.setParameters(parameters);
camera.PreviewDisplay(surfaceHolder);
camera.startPreview();
camera.autoFocus(null);
camera.takePicture(null, null, myjpegCallback);
PictureCallback myjpegCallback = new PictureCallback() {
    public void onPictureTaken(byte[] data, Camera camera) {
        Bitmap bm = BitmapFactory.decodeByteArray(data, 0, data.length);
        File file = new File(Environment.getExternalStorageDirectory(), &quot;logo.jpg&quot;);
        FileOutputStream outStream = new FileOutputStream(file);
        bm.compress(CompressFormat.JPEG, 100, outStream);
        outStream.close();
        camera.stopPreview();
        camera.startPreview();
    }
};
&lt;uses-permission android:name=&quot;android.permission.CAMERA&quot; /&gt;
&lt;uses-permission android:name=&quot;android.hardware.camera&quot; /&gt;
&lt;uses-permission android:name=&quot;android.hardware.camera.autofocus&quot; /&gt;
</code></pre><p>MediaRecorder除了可用于录制音频外，还可用于录制视频。使用MediaRecorder录制视频与录制音频的步骤基本相同。只是录制视频时不仅需要采集声音，还需要采集图像，为了让MediaRecorder录制时采集图像，应该在调用setAudioSource(int audio_source)方法时再调用setVideoSource(int video_source)方法来设置图像来源。录视频代码如下：</p>
<pre><code>//设置从摄像头采集图像
mediaRecorder.setVideoSource(MediaRecorder.VideoSource.CAMERA);
//设置视频文件的输出格式(必须在设置声音编码格式、图像编码格式之前设置)
mediaRecorder.setOutputFormat(MediaRecorder.OutputFormat.MPEG_4);
mediaRecorder.setAudioEncoder(MediaRecorder.AudioEncoder.DEFAULT);
mediaRecorder.setVideoEncoder(MediaRecorder.VideoEncoder.MPEG_4_SP);
mediaRecorder.setVideoSize(320, 280);
mediaRecorder.setVideoFrameRate(4);
//使用指定的SurfaceView来预览视频
mediaRecorder.setPreviewDisplay(sView.getHolder().getSurface());
mediaRecorder.prepare();
mediaRecorder.start();
</code></pre><h2 id="OpenGL与3D应用开发"><a href="#OpenGL与3D应用开发" class="headerlink" title="OpenGL与3D应用开发"></a>OpenGL与3D应用开发</h2><p>这个部分的知识比较少用，以后会总结</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2012/09/28/疯狂Android第二部分/" rel="next" title="疯狂Android第二部分">
                <i class="fa fa-chevron-left"></i> 疯狂Android第二部分
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2012/11/30/疯狂Android第四部分/" rel="prev" title="疯狂Android第四部分">
                疯狂Android第四部分 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        
<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80MTIxOC8xNzc2Ng=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="Frand Feng">
            
              <p class="site-author-name" itemprop="name">Frand Feng</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">90</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">58</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/frandfeng" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:frandfeng@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用ContentProvider实现数据共享"><span class="nav-number">1.</span> <span class="nav-text">使用ContentProvider实现数据共享</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Service与BroadcastReceiver"><span class="nav-number">2.</span> <span class="nav-text">Service与BroadcastReceiver</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-1-Service简介"><span class="nav-number">2.1.</span> <span class="nav-text">10.1 Service简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-跨进程调用Service-AIDL服务"><span class="nav-number">2.2.</span> <span class="nav-text">10.2 跨进程调用Service(AIDL服务)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-3-电话管理器-TelephonyManager"><span class="nav-number">2.3.</span> <span class="nav-text">10.3 电话管理器(TelephonyManager)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-4-短信管理器"><span class="nav-number">2.4.</span> <span class="nav-text">10.4 短信管理器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-音频管理器-AudioManager"><span class="nav-number">2.5.</span> <span class="nav-text">10.5 音频管理器(AudioManager)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-6-振动器"><span class="nav-number">2.6.</span> <span class="nav-text">10.6 振动器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-7-手机闹钟服务-AlarmManager"><span class="nav-number">2.7.</span> <span class="nav-text">10.7 手机闹钟服务(AlarmManager)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-8-广播消息"><span class="nav-number">2.8.</span> <span class="nav-text">10.8 广播消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-9-接收系统广播消息"><span class="nav-number">2.9.</span> <span class="nav-text">10.9 接收系统广播消息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多媒体应用开发"><span class="nav-number">3.</span> <span class="nav-text">多媒体应用开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-音频和视频的播放"><span class="nav-number">3.1.</span> <span class="nav-text">11.1 音频和视频的播放</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-使用MediaRecorder录制音频"><span class="nav-number">3.2.</span> <span class="nav-text">11.2 使用MediaRecorder录制音频</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-控制摄像头拍照和录视频短片"><span class="nav-number">3.3.</span> <span class="nav-text">11.3 控制摄像头拍照和录视频短片</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OpenGL与3D应用开发"><span class="nav-number">4.</span> <span class="nav-text">OpenGL与3D应用开发</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2011 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Frand Feng</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
