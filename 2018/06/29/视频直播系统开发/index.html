<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="OC,iOS,视频,">










<meta name="description" content="直播技术原理介绍和实现方案技术选型 如何搭建一个完整的视频直播系统？  直播整体架构     拉推流端涉及的音视频技术  网络协议选型 服务器CDN简介 iOS采集视频编码实现demo  流媒体服务器任务  数据分发 实时转码 录播 关键帧缓存 智能路由   音视频采集  AVFoundation：音频捕获-&amp;gt;音频AAC编码-&amp;gt;混合视频封装成flv/ts传输 CaptureSessio">
<meta name="keywords" content="OC,iOS,视频">
<meta property="og:type" content="article">
<meta property="og:title" content="视频直播系统开发">
<meta property="og:url" content="https://frandfeng.github.io/2018/06/29/视频直播系统开发/index.html">
<meta property="og:site_name" content="Frand Feng">
<meta property="og:description" content="直播技术原理介绍和实现方案技术选型 如何搭建一个完整的视频直播系统？  直播整体架构     拉推流端涉及的音视频技术  网络协议选型 服务器CDN简介 iOS采集视频编码实现demo  流媒体服务器任务  数据分发 实时转码 录播 关键帧缓存 智能路由   音视频采集  AVFoundation：音频捕获-&amp;gt;音频AAC编码-&amp;gt;混合视频封装成flv/ts传输 CaptureSessio">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://frandfeng.github.io/assets/blog/视频直播-直播总架构.png">
<meta property="og:image" content="https://frandfeng.github.io/assets/blog/视频直播-推流端.png">
<meta property="og:image" content="https://frandfeng.github.io/assets/blog/视频直播-拉流端.png">
<meta property="og:image" content="https://frandfeng.github.io/assets/blog/视频直播-视频采集.png">
<meta property="og:image" content="https://frandfeng.github.io/assets/blog/视频直播-视频抓取.png">
<meta property="og:image" content="https://frandfeng.github.io/assets/blog/视频直播-音频抓取.png">
<meta property="og:image" content="https://frandfeng.github.io/assets/blog/视频直播-LFLiveKit.png">
<meta property="og:image" content="https://frandfeng.github.io/assets/blog/视频直播-IJK底层实现.png">
<meta property="og:image" content="https://frandfeng.github.io/assets/blog/视频直播-FFMpeg底层拉流.png">
<meta property="og:image" content="https://frandfeng.github.io/assets/blog/视频直播-优化策略.png">
<meta property="og:image" content="https://frandfeng.github.io/assets/blog/视频直播-消息模块整体结构.png">
<meta property="og:image" content="https://frandfeng.github.io/assets/blog/视频直播-连接流程.png">
<meta property="og:image" content="https://frandfeng.github.io/assets/blog/视频直播-连接状态维护.png">
<meta property="og:updated_time" content="2018-11-25T10:25:08.543Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="视频直播系统开发">
<meta name="twitter:description" content="直播技术原理介绍和实现方案技术选型 如何搭建一个完整的视频直播系统？  直播整体架构     拉推流端涉及的音视频技术  网络协议选型 服务器CDN简介 iOS采集视频编码实现demo  流媒体服务器任务  数据分发 实时转码 录播 关键帧缓存 智能路由   音视频采集  AVFoundation：音频捕获-&amp;gt;音频AAC编码-&amp;gt;混合视频封装成flv/ts传输 CaptureSessio">
<meta name="twitter:image" content="https://frandfeng.github.io/assets/blog/视频直播-直播总架构.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://frandfeng.github.io/2018/06/29/视频直播系统开发/">





  <title>视频直播系统开发 | Frand Feng</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?033e49e2955598a86e6aef7bb5784a98";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Frand Feng</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Win yourself to succeed!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://frandfeng.github.io/2018/06/29/视频直播系统开发/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Frand Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Frand Feng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">视频直播系统开发</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-29T00:00:00+08:00">
                2018-06-29
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>直播技术原理介绍和实现方案技术选型</p>
<p>如何搭建一个完整的视频直播系统？</p>
<ul>
<li><p>直播整体架构</p>
<p>  <img src="/assets/blog/视频直播-直播总架构.png" alt=""></p>
</li>
<li><p>拉推流端涉及的音视频技术</p>
</li>
<li>网络协议选型</li>
<li>服务器CDN简介</li>
<li><p>iOS采集视频编码实现demo</p>
</li>
<li><p>流媒体服务器任务</p>
<ul>
<li>数据分发</li>
<li>实时转码</li>
<li>录播</li>
<li>关键帧缓存</li>
<li>智能路由</li>
</ul>
</li>
<li><p>音视频采集</p>
<ul>
<li>AVFoundation：音频捕获-&gt;音频AAC编码-&gt;混合视频封装成flv/ts传输</li>
<li>CaptureSession：视频捕获-&gt;视频预处理-&gt;视频H.264编码-&gt;混合音频封装成flv/ts传输</li>
</ul>
</li>
<li><p>视频预处理</p>
<ul>
<li>美颜</li>
<li>水印</li>
<li>人脸识别</li>
<li>GUPImage：第三方框架，有很多种功能，可以处理上边三个需求，还有其他SDK，如讯飞SDK、商汤SDK等</li>
</ul>
</li>
<li><p>推流</p>
<p>  <img src="/assets/blog/视频直播-推流端.png" alt=""></p>
<ul>
<li>封装</li>
<li>流媒体协议RTMP、RTSP、HLS、HTTP-FLV</li>
<li>librtmp rtmp协议实现</li>
<li>HLS使用HTTP协议上传</li>
<li>webRTC实时消息传输协议实现，可以用点对点来做连麦，即多人会议，实时性较高</li>
</ul>
</li>
<li><p>拉流</p>
<p>  <img src="/assets/blog/视频直播-拉流端.png" alt=""></p>
<ul>
<li>流媒体协议RTMP、RTSP、HLS、HTTP-FLV</li>
<li>ijkplayer开源播放器</li>
<li>OpenGL渲染</li>
<li>解封装</li>
</ul>
</li>
<li><p>音视频解码</p>
<ul>
<li>最初的流是封装成flv、ts格式，先解封装成视频和音频两个部分</li>
<li>视频硬解码成YUV格式 VideoToolbox：iOS8.0以上支持</li>
<li>视频软解码成YUV格式 x264、FFMpeg</li>
<li>音频硬解码成PCM格式 AudioToolbox</li>
<li>音频软解码成PCM格式 fdk_acc</li>
<li>最后将音视频交给播放器播放</li>
</ul>
</li>
<li><p>聊天互动</p>
<ul>
<li>IM：MQTT、WebSocket</li>
<li>聊天室</li>
<li>礼物</li>
</ul>
</li>
</ul>
<p>什么是视频编码：</p>
<p>使用特定的压缩算法压缩视频数据，便于视频的传输和存储。编码方式有H264（比265节省40%的空间），H265（iOS11以上原生支持），V8，V9（这两个是google提出，可以直接在播放器中播放，android端比较常用）</p>
<p>H264的原理及其中的概念：每个图片跟前边的图片差异很小，所以提出一个关键帧，后边的帧只记住改变即可</p>
<ul>
<li>I帧（关键帧）、B帧（依靠前后帧还原，复杂度较高）、P帧（依靠前边的帧还原）</li>
<li>GOP（两个关键帧之间的帧数）</li>
<li>FPS：frame per second，每秒的帧数，一般是30</li>
<li>码率 越大越清晰，相当于帧宽，帧的大小</li>
</ul>
<p>H264帧结构：（I P P P I P P P I P）</p>
<ul>
<li>序列参数集SPS：Sequence Parameter Set，包括与图像序列（定义为两个IDR图像之间的所有图像）有关的所有信息，应用于已编码视频序列。</li>
<li>图像参数集PPS：Picture Parameter Set，包含所有属于该图像的相关信息，用于解码已编码视频序列中的1个或多个独立的图像。</li>
</ul>
<p>每个P中包含</p>
<ul>
<li>分界符(0001)</li>
<li>序列参数集</li>
<li>图像参数集</li>
<li>SEL</li>
<li>基本图像（包含很多slice）</li>
<li>冗余图像</li>
<li>序列结束符</li>
</ul>
<p>FLV格式：Header/PreviousTagSize0/Tag1/previousTagSize1/Tag2/previousTagSize2…Tag n/PreviousTagSize n</p>
<ul>
<li><p>Header：</p>
<ul>
<li>3byte：文件类型，即flv</li>
<li>1byte：版本号</li>
<li>1byte：流信息（各个位表示不同信息，最后一位是1表示有视频流，倒数第三位是1表示有音频流）</li>
<li>4byte：header长度</li>
</ul>
</li>
<li><p>Tag：</p>
<ul>
<li>1byte：tag类型，表示是音频还是视频还是字母或者是数据块</li>
<li>3byte：数据区长度</li>
<li>3byte：时间戳，单位毫秒</li>
<li>1byte：时间戳扩展</li>
<li>3byte：streamID，流ID</li>
<li>数据区：长度由数据区长度字段决定</li>
</ul>
</li>
<li><p>音频Tag：</p>
<ul>
<li>4bit：音频格式</li>
<li>2bit：采样率</li>
<li>1bit：采样长度</li>
<li>1bit：音频类型</li>
<li>实际的音频数据</li>
</ul>
</li>
<li><p>视频Tag：</p>
<ul>
<li>4bit：帧类型</li>
<li>4bit：编码ID</li>
<li>实际的视频数据</li>
</ul>
</li>
</ul>
<p>传输协议HLS，HTTP Live Streaming（苹果推出）</p>
<p>基于HLS的直播流URL式一个m3u8的文件，里面包含了最近若干个小视频TS(一种视频封装格式，这里就不扩展介绍)文件，每次通过请求m3u8文件得到ts小视频列表，然后一个一个的下载缓冲播放</p>
<p>HTML5可以直接播放，不需要独立App支持，延时一般10s</p>
<p>音频编码AAC</p>
<p>采样率为44.1kHZ，采样大小为16bit的双声道。PCM的大小为<code>44.1*16*2bps=176kb/s</code>。AAC通畅压缩比为18：1，也有资料说是20：1，经过AAC压缩后的大小约为12kb/s左右，远远低于视频压缩后的大小</p>
<p>为什么要封装？</p>
<p>将经过编码的音视频帧数据信息和字幕等信息组织起来，便于播放端解析数据，对不同的数据选择不同的解码器进行解码，以完成音视频同步，字幕同步等。封装格式主要有rmvc、avi、mkv、mp4、flv、ts等</p>
<p>服务器CDN简介：Content Delivery Network</p>
<ul>
<li>视频录制</li>
<li>断流检测</li>
<li>自动鉴黄</li>
<li>GOP缓存</li>
<li>智能路由</li>
<li>实时转码，多分辨率清晰度</li>
</ul>
<p>CMTime：</p>
<ul>
<li>可以表示时间点，也可以表示时间长度</li>
<li>主要的属性 value/timeScale，value表示时间粒度的数量，timeScale表示时间单位粒度</li>
<li>value/timeScale = seconds 表示时间点</li>
</ul>
<p>CMSampleBufferRef中的几个数据结构</p>
<ul>
<li>CVPixelBuffer：编码前和解码后的图像数据结构</li>
<li>CMBlockBuffer：编码后的图像数据结构</li>
<li>CMSampleBuffer：存放编解码前后的视频图像的容器数据结构，包含CMTime，CMVideoFormatDesc，还有CVPixelBuffer或CMBlockBuffer</li>
</ul>
<p>视频的一个CMSampleBufferRef对应很多个CMBlockBuffer</p>
<ol>
<li><p>捕捉视频流及其压缩（h264用vlc播放）</p>
<p> <img src="/assets/blog/视频直播-视频采集.png" alt=""></p>
<pre><code>//ViewController.m
- (void)startCamera {
    AVCaptureDevice *captureDevice = [AVCaptureDevice defaultDeviceWithMediaType:AVMediaTypeVideo];
    AVCaptureDeviceInput *captureDeviceInput = [AVCaptureDeviceInput deviceInputWithDevice:captureDevice error:nil];

    //make output device
    AVCaptureVideoDataOutput *captureVideoDataOutput = [[AVCaptureVideoDataOutput alloc] init];
    NSNumber *val = [NSNumber numberWithUnsignedInteger:kCVPixelFormatType_420YpCbCr8BiPlanarFullRange];
    NSDictionary *videoSetting = [NSDictionary dictionaryWithObject:val forKey:(NSString *)kCVPixelBufferPixelFormatTypeKey];
    captureVideoDataOutput.videoSettings = videoSetting;
    [captureVideoDataOutput setSampleBufferDelegate:self queue:dispatch_get_main_queue()];

    self.captureSession = [[AVCaptureSession alloc] init];
    [self.captureSession addInput:captureDeviceInput];
    [self.captureSession addOutput:captureVideoDataOutput];

    [self.captureSession beginConfiguration];
    [self.captureSession setSessionPreset:AVCaptureSessionPresetMedium];
    [self.captureSession setSessionPreset:AVCaptureSessionPreset640x480];
    //当把一个输入和输出添加到AVCaptureSession之后，AVCaptureSession就会在输入、输出设备之间建立连接，而且通过AVCaptureOutput可以获取这个连接对象
    self.connection = [captureVideoDataOutput connectionWithMediaType:AVMediaTypeVideo];
    [self setRelativeVideoOrientation];
    NSNotificationCenter *notify = [NSNotificationCenter defaultCenter];
    [notify addObserver:self selector:@selector(statusBarOrientationDidChange:) name:@&quot;StatusBarOrientationDidChange&quot; object:nil];
    [self.captureSession commitConfiguration];
    [self.captureSession startRunning];
    self.fileHandler = [NSFileHandle fileHandleForWritingAtPath:self.savePath];

    [self.encoder initEncoderWithWidth:480 height:640];
    self.encoder.delegate = self;
}

#pragma mark - AVCaptureVideoDataOutputSampleBufferDelegate
- (void)captureOutput:(AVCaptureOutput *)output didOutputSampleBuffer:(CMSampleBufferRef)sampleBuffer fromConnection:(AVCaptureConnection *)connection {
    CVImageBufferRef imageBuffer = CMSampleBufferGetImageBuffer(sampleBuffer);
    CGSize imageSize = CVImageBufferGetEncodedSize(imageBuffer);
    NSLog(@&quot;ImageBufferSize ----- width:%.1f, height:%.1f&quot;, imageSize.width, imageSize.height);
    //直接把samplebuffer传给AVSampleBufferDisplayLayer进行预览播放
    [self.displayLayer enqueueSampleBuffer:sampleBuffer];
    [self.encoder encode:sampleBuffer];
}

#pragma mark - H264EncoderDelegate
- (void)didGetSparameterSet:(NSData *)sps pictureParameterSet:(NSData *)pps {
    NSLog(@&quot;didGet SparameterSet %d PparameterSet %d&quot;, (int)[sps length], (int)[pps length]);
    const char bytes[] = &quot;\x00\x00\x00\x01&quot;;
    //string literals have implicit trainling &apos;\0&apos;
    size_t length = (sizeof(bytes)) - 1;
    NSData *byteHeader = [NSData dataWithBytes:bytes length:length];
    [self.fileHandler writeData:byteHeader];
    [self.fileHandler writeData:sps];
    [self.fileHandler writeData:byteHeader];
    [self.fileHandler writeData:pps];
    NSLog(@&quot;write ps finished&quot;);
}

- (void)didGetEncodedData:(NSData *)data isKeyFrame:(BOOL)isKeyFrame {
    if (self.fileHandler != NULL) {
        const char bytes[] = &quot;\x00\x00\x00\x01&quot;;
        size_t length = (sizeof(bytes)) - 1;
        NSData *byteHeader = [NSData dataWithBytes:bytes length:length];
        [self.fileHandler writeData:byteHeader];
        [self.fileHandler writeData:data];
        NSLog(@&quot;write data finished&quot;);
    }
}

- (void)initEncoderWithWidth:(int)width height:(int)height {
    dispatch_sync(workQueue, ^{
        OSStatus status = VTCompressionSessionCreate(NULL, width, height, kCMVideoCodecType_H264, NULL, NULL, NULL, didCompressH264, (__bridge void *)self, &amp;encodeSession);
        NSLog(@&quot;H264: VTCompressionSessionCreate %d&quot;, (int)status);
        if (status != 0) {
            NSLog(@&quot;H264: Unable to create a H264 session&quot;);
            return;
        }
        //最大关键帧间隔，可设定为fps的2倍，影响一个gop的大小
        VTSessionSetProperty(encodeSession, kVTCompressionPropertyKey_MaxKeyFrameInterval, (__bridge CFTypeRef)@(gop));
        //一个GOP的时间间隔
        VTSessionSetProperty(encodeSession, kVTCompressionPropertyKey_MaxKeyFrameIntervalDuration, (__bridge CFTypeRef)@(gop/videoFrameRate));
        //设置帧率，即每秒有多少帧数据
        VTSessionSetProperty(encodeSession, kVTCompressionPropertyKey_ExpectedFrameRate, (__bridge CFTypeRef)@(videoFrameRate));
        //码率，单位是bps，即每秒多少bit
        VTSessionSetProperty(encodeSession, kVTCompressionPropertyKey_AverageBitRate, (__bridge CFTypeRef)@(averageBitRate));
        //设置码率的最高限制，不超过平均码率的1.5倍，因为这里的单位是byte，所以除以8，这是为了防止某一秒码率超过限制
        NSArray *limit = @[@(averageBitRate*1.5/8), @(1)];
        VTSessionSetProperty(encodeSession, kVTCompressionPropertyKey_DataRateLimits, (__bridge CFArrayRef)limit);
        //是否实时编码，YES时降低编码复杂度，快速编码
        VTSessionSetProperty(encodeSession, kVTCompressionPropertyKey_RealTime, kCFBooleanTrue);
        //调整编码等级，H264有4个编码等级，有baseline、extend、main、high，最前边的编码复杂度低，解码效率更高，压缩率比较低
        VTSessionSetProperty(encodeSession, kVTCompressionPropertyKey_ProfileLevel, kVTProfileLevel_H264_Main_AutoLevel);
        //是否在编码中使用B帧，因为B帧是双向预测帧，所以编码时间顺序和展示时间顺序不同，设置为true压缩率更高
        VTSessionSetProperty(encodeSession, kVTCompressionPropertyKey_AllowFrameReordering, kCFBooleanTrue);
        //基于上下文的自适应可变长编码 和 基于上下文的自适应二进制算术编码 选择熵编码方式
        VTSessionSetProperty(encodeSession, kVTCompressionPropertyKey_H264EntropyMode, kVTH264EntropyMode_CABAC);
        VTCompressionSessionPrepareToEncodeFrames(encodeSession);
    });

}

- (void)encode:(CMSampleBufferRef)sampleBuffer {
    dispatch_sync(workQueue, ^{
        frameCount ++;
        CVImageBufferRef imageBuffer = (CVImageBufferRef)CMSampleBufferGetImageBuffer(sampleBuffer);
        //create properties
        CMTime presentationTimeStamp = CMTimeMake(frameCount, (int32_t)videoFrameRate);
        CMTime duration = CMTimeMake(1, (int32_t)videoFrameRate);
        VTEncodeInfoFlags flags;
        NSDictionary *properties = nil;
        if (frameCount % (int32_t)gop == 0) {
            properties = @{(__bridge NSString*)kVTEncodeFrameOptionKey_ForceKeyFrame:@YES};
        }
        //pass it to the encoder
        OSStatus statusCode = VTCompressionSessionEncodeFrame(encodeSession, imageBuffer, presentationTimeStamp, duration, (__bridge CFDictionaryRef)properties, NULL, &amp;flags);
        //check for error
        if (statusCode != noErr) {
            NSLog(@&quot;H264: VTCompressionSessionEncodeFrame failed with %d&quot;, (int)statusCode);
            //end the session
            VTCompressionSessionInvalidate(encodeSession);
            CFRelease(encodeSession);
            encodeSession = NULL;
            return;
        }
        NSLog(@&quot;H264: VTCompressionSessionEncodeFrame success&quot;);
    });
}

//VTCompressionOutputCallback(回调方法) 由VTCompressionSessionCreate调用
void didCompressH264(void *outputCallbackRefCon, void *sourceFrameRefCon, OSStatus status, VTEncodeInfoFlags infoFlags, CMSampleBufferRef sampleBuffer) {
    NSLog(@&quot;didCompressH264 called with status %d, infoFlags %d&quot;, (int)status, (int)infoFlags);
    if (status != 0) return;
    if (!CMSampleBufferDataIsReady(sampleBuffer)) {
        NSLog(@&quot;didCompressH264 data is not ready&quot;);
        return;
    }
    H264Encoder *encoder = (__bridge H264Encoder *)outputCallbackRefCon;
    //check if we have got a key frame first
    BOOL keyFrame = !CFDictionaryContainsKey(CFArrayGetValueAtIndex(CMSampleBufferGetSampleAttachmentsArray(sampleBuffer, YES), 0) , kCMSampleAttachmentKey_NotSync);
    if (keyFrame) {
        CMFormatDescriptionRef format = CMSampleBufferGetFormatDescription(sampleBuffer);
        size_t sparamenterSetSize, sparameterSetCount;
        const uint8_t *sparameterSet;
        OSStatus statusCode = CMVideoFormatDescriptionGetH264ParameterSetAtIndex(format, 0, &amp;sparameterSet, &amp;sparamenterSetSize, &amp;sparameterSetCount, 0);
        if (statusCode == noErr) {
            size_t pparameterSetSize, pparameterSetCount;
            const uint8_t *pparameterSet;
            OSStatus statusCode = CMVideoFormatDescriptionGetH264ParameterSetAtIndex(format, 1, &amp;pparameterSet, &amp;pparameterSetSize, &amp;pparameterSetCount, 0);
            if (statusCode == noErr) {
                encoder-&gt;sps = [NSData dataWithBytes:sparameterSet length:sparamenterSetSize];
                encoder-&gt;pps = [NSData dataWithBytes:pparameterSet length:pparameterSetSize];
                if (encoder-&gt;_delegate) {
                    [encoder-&gt;_delegate didGetSparameterSet:encoder-&gt;sps pictureParameterSet:encoder-&gt;pps];
                }
            }
        }
    }
    CMBlockBufferRef dataBuffer = CMSampleBufferGetDataBuffer(sampleBuffer);
    size_t length, totalLength;
    char *dataPointer;
    OSStatus statusCodeRet = CMBlockBufferGetDataPointer(dataBuffer, 0, &amp;length, &amp;totalLength, &amp;dataPointer);
    if (statusCodeRet == noErr) {
        size_t bufferOffset = 0;
        static const int AVCCHeaderLength = 4;
        //一般情况下都是只有1帧，在最开始编码的时候有2帧，取最后一帧
        while (bufferOffset &lt; totalLength - AVCCHeaderLength) {
            if (bufferOffset != 0) {
                NSLog(@&quot;一般情况下都是只有1帧，此时不是一帧 %d&quot;, (int)bufferOffset);
            }
            //read the nal unit length
            uint32_t NALUnitLength = 0;
            memcpy(&amp;NALUnitLength, dataPointer+bufferOffset, AVCCHeaderLength);
            //convert the length value from Big-endian to Little-endian,网络字节序一般使用大端字节序
            NALUnitLength = CFSwapInt32BigToHost(NALUnitLength);
            //data即为一帧h264数据
            //如果保存到文件中，需要将此数据前加上[0 0 0 1]4个字节，按顺序写入到h264文件中
            //如果推流，需要将此数据前加上4个字节表示数据长度的数字，此数字需转为大端字节序。
            //关于大端模式和小端模式
            NSData *data = [[NSData alloc] initWithBytes:dataPointer+bufferOffset+AVCCHeaderLength length:NALUnitLength];
            [encoder-&gt;_delegate didGetEncodedData:data isKeyFrame:keyFrame];

            //move to the next NAL unit in the block buffer
            bufferOffset += AVCCHeaderLength + NALUnitLength;
        }
    }
}
</code></pre></li>
<li><p>LFLiveKit推视频和音频流（oc写的）</p>
<p> <img src="/assets/blog/视频直播-视频抓取.png" alt=""><br> <img src="/assets/blog/视频直播-音频抓取.png" alt=""><br> <img src="/assets/blog/视频直播-LFLiveKit.png" alt=""></p>
<pre><code>//LFLiveConfiguration
//LFLiveVideoConfiguration.h
/// 视频的分辨率，宽高务必设定为 2 的倍数，否则解码播放时可能出现绿边(这个videoSizeRespectingAspectRatio设置为YES则可能会改变)
@property (nonatomic, assign) CGSize videoSize;
/// 输出图像是否等比例,默认为NO
@property (nonatomic, assign) BOOL videoSizeRespectingAspectRatio;
/// 视频输出方向
@property (nonatomic, assign) UIInterfaceOrientation outputImageOrientation;
/// 自动旋转(这里只支持 left 变 right  portrait 变 portraitUpsideDown)
@property (nonatomic, assign) BOOL autorotate;
/// 视频的帧率，即 fps
@property (nonatomic, assign) NSUInteger videoFrameRate;
/// 视频的最大帧率，即 fps
@property (nonatomic, assign) NSUInteger videoMaxFrameRate;
/// 视频的最小帧率，即 fps
@property (nonatomic, assign) NSUInteger videoMinFrameRate;
/// 最大关键帧间隔，可设定为 fps 的2倍，影响一个 gop 的大小
@property (nonatomic, assign) NSUInteger videoMaxKeyframeInterval;
/// 视频的码率，单位是 bps
@property (nonatomic, assign) NSUInteger videoBitRate;
/// 视频的最大码率，单位是 bps
@property (nonatomic, assign) NSUInteger videoMaxBitRate;
/// 视频的最小码率，单位是 bps
@property (nonatomic, assign) NSUInteger videoMinBitRate;
///&lt; 分辨率
@property (nonatomic, assign) LFLiveVideoSessionPreset sessionPreset;
///&lt; ≈sde3分辨率
@property (nonatomic, assign, readonly) NSString *avSessionPreset;
///&lt; 是否是横屏
@property (nonatomic, assign, readonly) BOOL landscape;
</code></pre></li>
</ol>
<pre><code>//LFLiveAudioConfiguration.h
/// 声道数目(default 2)
@property (nonatomic, assign) NSUInteger numberOfChannels;
/// 采样率
@property (nonatomic, assign) LFLiveAudioSampleRate audioSampleRate;
/// 码率
@property (nonatomic, assign) LFLiveAudioBitRate audioBitrate;
/// flv编码音频头 44100 为0x12 0x10
@property (nonatomic, assign, readonly) char *asc;
/// 缓存区长度
@property (nonatomic, assign,readonly) NSUInteger bufferLength;

//LFLiveSessionConfiguration
@interface LFLiveSession : NSObject
/** The delegate of the capture. captureData callback */
@property (nullable, nonatomic, weak) id&lt;LFLiveSessionDelegate&gt; delegate;
/** The running control start capture or stop capture*/
@property (nonatomic, assign) BOOL running;
/** The preView will show OpenGL ES view*/
@property (nonatomic, strong, null_resettable) UIView *preView;
/** The captureDevicePosition control camraPosition ,default front*/
@property (nonatomic, assign) AVCaptureDevicePosition captureDevicePosition;
/** The beautyFace control capture shader filter empty or beautiy */
@property (nonatomic, assign) BOOL beautyFace;
/** The beautyLevel control beautyFace Level. Default is 0.5, between 0.0 ~ 1.0 */
@property (nonatomic, assign) CGFloat beautyLevel;
/** The brightLevel control brightness Level, Default is 0.5, between 0.0 ~ 1.0 */
@property (nonatomic, assign) CGFloat brightLevel;
/** The torch control camera zoom scale default 1.0, between 1.0 ~ 3.0 */
@property (nonatomic, assign) CGFloat zoomScale;
/** The torch control capture flash is on or off */
@property (nonatomic, assign) BOOL torch;
/** The mirror control mirror of front camera is on or off */
@property (nonatomic, assign) BOOL mirror;
/** The muted control callbackAudioData,muted will memset 0.*/
@property (nonatomic, assign) BOOL muted;
/*  The adaptiveBitrate control auto adjust bitrate. Default is NO */
@property (nonatomic, assign) BOOL adaptiveBitrate;
/** The stream control upload and package*/
@property (nullable, nonatomic, strong, readonly) LFLiveStreamInfo *streamInfo;
/** The status of the stream .*/
@property (nonatomic, assign, readonly) LFLiveState state;
/** The captureType control inner or outer audio and video .*/
@property (nonatomic, assign, readonly) LFLiveCaptureTypeMask captureType;
/** The showDebugInfo control streamInfo and uploadInfo(1s) *.*/
@property (nonatomic, assign) BOOL showDebugInfo;
/** The reconnectInterval control reconnect timeInterval(重连间隔) *.*/
@property (nonatomic, assign) NSUInteger reconnectInterval;
/** The reconnectCount control reconnect count (重连次数) *.*/
@property (nonatomic, assign) NSUInteger reconnectCount;
/*** The warterMarkView control whether the watermark is displayed or not ,if set ni,will remove watermark,otherwise add. 
 set alpha represent mix.Position relative to outVideoSize.
 *.*/
@property (nonatomic, strong, nullable) UIView *warterMarkView;
/* The currentImage is videoCapture shot */
@property (nonatomic, strong,readonly ,nullable) UIImage *currentImage;
/* The saveLocalVideo is save the local video */
@property (nonatomic, assign) BOOL saveLocalVideo;
/* The saveLocalVideoPath is save the local video  path */
@property (nonatomic, strong, nullable) NSURL *saveLocalVideoPath;
</code></pre><ol start="3">
<li><p>IJKMediaFramework拉流及播放</p>
<p> <img src="/assets/blog/视频直播-IJK底层实现.png" alt=""></p>
<pre><code>//Player.h
@interface Player : NSObject
@property (nonatomic, strong) NSString *url;
@property (nonatomic, assign) BOOL isPlaying;
@property (nonatomic, readonly) UIView *view;
- (BOOL)play;
- (BOOL)retryPlay;
- (BOOL)stopPlay;
- (void)pause;
- (void)resume;
@end

//Player.m
@interface Player()
@property (nonatomic, strong) IJKFFMoviePlayerController *playerController;
@property (nonatomic, strong) IJKFFOptions *options;
@property (nonatomic, assign) BOOL paused;
@end
@implementation Player
- (BOOL)play {
    if (self.url == nil) {
        return NO;
    }
    self.playerController = [self createPlayerController];
    [self.playerController prepareToPlay];
    return YES;
}
- (BOOL)retryPlay {
    return YES;
}
- (BOOL)stopPlay {
    if (self.playerController) {
        [self.playerController shutdown];
        [self.playerController.view removeFromSuperview];
        self.playerController = nil;
    }
    return YES;
}
- (void)resume {
    self.paused = NO;
}
- (void)pause {
    self.paused = YES;
}
- (UIView *)view {
    return self.playerController.view;
}
- (IJKFFMoviePlayerController *)createPlayerController {
    IJKFFMoviePlayerController *playerController = [[IJKFFMoviePlayerController alloc] initWithContentURLString:self.url withOptions:self.options];
    playerController.scalingMode = IJKMPMovieScalingModeAspectFill;
    playerController.shouldAutoplay = YES;
    [playerController setPauseInBackground:YES];
    return playerController;
}
- (IJKFFOptions *)options {
    if (_options==nil) {
        //关于详细的播放器配置，请参考文件ff_ffplay_options.c//PPT拉流流程图
        IJKFFOptions *options = [IJKFFOptions optionsByDefault];
        [options setFormatOptionIntValue:5000000 forKey:@&quot;analyzeduration&quot;];//最长分析流时间
        [options setFormatOptionIntValue:15000000 forKey:@&quot;timeout&quot;];//超时时间15s
        [options setFormatOptionIntValue:5 forKey:@&quot;fpsprobesize&quot;];//取多少帧用于分析
        [options setFormatOptionValue:@&quot;nobuffer&quot; forKey:@&quot;fflags&quot;];//开启之后，会出现进入页面立马卡顿一下的问题
        [options setFormatOptionIntValue:4096 forKey:@&quot;probsize&quot;];//一次分析包大小
        [options setPlayerOptionIntValue:0 forKey:@&quot;packet-buffering&quot;];//连接成功后，继续读取多少个包开始播放
        [options setPlayerOptionIntValue:5 forKey:@&quot;min-frames&quot;];//最少读取多少个frame之后停止预读
        [options setPlayerOptionIntValue:1 forKey:@&quot;videotoolbox&quot;];//开启硬件编码
        [options setPlayerOptionIntValue:29.97 forKey:@&quot;max-fps&quot;];//最大支持帧率
        [options setPlayerOptionIntValue:1 forKey:@&quot;framedrop&quot;];//开启后，如果cpu处理不过来则会丢帧
        //开启会丢帧，不过可以加快播放速度(在硬解码的情况下，则没有明显掉帧情况，而且只有开启直播这一下会出现掉帧)
        //根本问题在于，当音视频流不同步的时候，会出现丢帧的情况，这种情况使用软解码会很明显，硬解码则不会
        [options setCodecOptionIntValue:IJK_AVDISCARD_DEFAULT forKey:@&quot;skip_loop_filter&quot;];
        [options setCodecOptionIntValue:IJK_AVDISCARD_NONREF forKey:@&quot;skip_frame&quot;];
        //下面两个参数由播放类型决定，自行增加。（点播需要）
//        [options setPlayerOptionIntValue:1 forKey:@&quot;an&quot;];//audio disable禁止音频
//        [options setPlayerOptionIntValue:(50*1024) forKey:@&quot;max-buffer-size&quot;];//缓存大小（直播小，点播大保证流畅）
//        [options setFormatOptionIntValue:32 forKey:@&quot;rtbufsize&quot;];//最大内存大小用于实时缓存
        options.showHudView = NO;
        _options = options;
    }
    return _options;
}
- (void)setPaused:(BOOL)paused {
    _paused = paused;
    if (_paused) {
        [self.playerController pause];
    } else {
        [self.playerController play];
    }
}
@end

//PlayViewController.m
@implementation PlayViewController
- (void)viewDidLoad {
    [super viewDidLoad];
    self.player = [[Player alloc] init];
    self.player.url = @&quot;rtmp://120.26.43.68:1935/hls/test&quot;;
    [self.player play];
    [self setupViews];
}
- (void)setupViews {
    [self.view insertSubview:self.player.view atIndex:0];
    self.player.view.frame = self.view.bounds;
}
- (IBAction)closeBtnTouched:(id)sender {
    if (self.player) {
        [self.player stopPlay];
        [self.player.view removeFromSuperview];
    }
    [self dismissViewControllerAnimated:YES completion:nil];
}
@end
</code></pre><p> <img src="/assets/blog/视频直播-FFMpeg底层拉流.png" alt=""></p>
</li>
<li><p>全局优化</p>
<p> <img src="/assets/blog/视频直播-优化策略.png" alt=""></p>
</li>
</ol>
<blockquote>
<p>Mac 上安装Nginx+rtmp的操作请自行百度</p>
</blockquote>
<p>实时消息通道</p>
<ul>
<li>xmpp：IM，GTALK，MSN都是基于此实现，此种协议只要客户端和服务器都基于此，就可以相互发送消息，如GTALK给MSN发消息，类似于邮件的STMP/POP协议</li>
<li>websocket：轻量级消息通道，客户端和服务端可以相互发送消息，浏览器原生支持此协议</li>
<li><p>mqtt：IBM推出的基于物联网的消息通道。协议比较简单，耗流量较少，用于嵌入式的消息通道，常用于低带宽和不稳定的网络</p>
<p>  <img src="/assets/blog/视频直播-消息模块整体结构.png" alt=""><br>  <img src="/assets/blog/视频直播-连接流程.png" alt=""><br>  <img src="/assets/blog/视频直播-连接状态维护.png" alt=""></p>
</li>
</ul>
<p>MQTT：</p>
<ul>
<li>订阅/发布消息模式，支持一对多的消息发布</li>
<li>协议头开销小，降低网络流量</li>
<li>提供服务质量选择：至多一次、至少一次、只有一次</li>
</ul>
<blockquote>
<p>Mac 上安装Mosquitto的的操作请自行百度或参见视频教程</p>
</blockquote>
<p>代码实现</p>
<ul>
<li>建立消息通道：MQTT第三方Pod框架</li>
<li>列表刷新方案：多少秒检测刷新一次，达到多少数量刷新一次，RunLoop空闲时刷新。注：解析和高度计算放后台</li>
<li>YYText图片加载：CoreText</li>
</ul>
<p>动画方案介绍：</p>
<ul>
<li>CoreAnimation：小动画或者大动画实现</li>
<li>帧动画</li>
<li>html5动画</li>
<li>视频播放</li>
<li>flash动画解析：FlashAnimationToMobile</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/OC/" rel="tag"># OC</a>
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
            <a href="/tags/视频/" rel="tag"># 视频</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/05/25/iOSRunTime/" rel="next" title="iOSRunTime">
                <i class="fa fa-chevron-left"></i> iOSRunTime
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/07/27/RAC详解/" rel="prev" title="RAC详解">
                RAC详解 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        
<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80MTIxOC8xNzc2Ng=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="Frand Feng">
            
              <p class="site-author-name" itemprop="name">Frand Feng</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">88</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">56</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/frandfeng" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:frandfeng@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2011 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Frand Feng</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
